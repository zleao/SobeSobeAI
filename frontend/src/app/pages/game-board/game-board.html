<div class="min-h-screen bg-gradient-to-br from-green-700 via-green-600 to-green-800 p-4">
  <div class="max-w-7xl mx-auto">
    <!-- Loading State -->
    @if (loading()) {
      <div class="flex justify-center items-center h-64">
        <div class="text-white text-xl">Loading game...</div>
      </div>
    }

    <!-- Error Message -->
    @if (error()) {
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {{ error() }}
      </div>
    }

    <!-- Game Board -->
    @if (gameState()) {
      <div class="space-y-4">
        <!-- Header: Game Info -->
        <div class="bg-white rounded-lg shadow-lg p-4">
          <div class="flex justify-between items-center">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">SobeSobe Game</h1>
              <p class="text-sm text-gray-500">Logged in as {{ getCurrentUserName() }}</p>
              @if (gameState()!.currentRound) {
                <p class="text-gray-600">
                  Round {{ gameState()!.currentRound!.roundNumber }} - {{ getRoundStatusText(gameState()!.currentRound!.status) }}
                  @if (gameState()!.currentRound!.trumpSuit) {
                    <span class="ml-2">
                      | Trump: 
                      <span [class]="getCardColor(gameState()!.currentRound!.trumpSuit!)">
                        {{ getCardSymbol(gameState()!.currentRound!.trumpSuit!) }} {{ gameState()!.currentRound!.trumpSuit }}
                      </span>
                      ({{ gameState()!.currentRound!.trickValue }} pts/trick)
                    </span>
                  }
                </p>
              }
            </div>
            <div class="flex items-center gap-2">
              <button
                (click)="router.navigate(['/lobby'])"
                class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
              >
                Back to Lobby
              </button>
              @if (isCreator()) {
                <button
                  (click)="endGame()"
                  [disabled]="endingGame()"
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  @if (endingGame()) {
                    <span>Ending...</span>
                  } @else {
                    <span>End Game</span>
                  }
                </button>
              }
            </div>
          </div>
        </div>

        <!-- Trump Selection (if needed) -->
        @if (gameState()!.currentRound && isRoundStatus(gameState()!.currentRound!.status, 1)) {
          <div class="bg-white rounded-lg shadow-lg p-6">
            @if (isPartyPlayer()) {
              <h2 class="text-xl font-bold mb-4">Select Trump Suit</h2>
              @if (!hasInitialCards()) {
                <p class="text-gray-600 mb-4">Choose the trump now (blind, double points) or deal the initial cards first.</p>
                <div class="flex justify-center mb-6">
                  <button
                    (click)="dealInitialCards()"
                    [disabled]="dealingInitialCards()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                  >
                    @if (dealingInitialCards()) {
                      <span>Dealing...</span>
                    } @else {
                      <span>Deal Initial Cards</span>
                    }
                  </button>
                </div>
              } @else {
                <p class="text-gray-600 mb-4">Initial cards dealt. Choose the trump suit.</p>
              }
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                @for (suit of ['Hearts', 'Diamonds', 'Clubs', 'Spades']; track suit) {
                  <button
                    (click)="selectTrump(suit, !hasInitialCards())"
                    [class]="'flex items-center justify-center gap-2 px-6 py-8 rounded-lg border-2 hover:border-blue-500 hover:bg-blue-50 transition-colors ' + getCardColor(suit)"
                  >
                    <span class="text-4xl">{{ getCardSymbol(suit) }}</span>
                    <span class="text-lg font-semibold">{{ suit }}</span>
                  </button>
                }
              </div>
            } @else {
              <h2 class="text-xl font-bold mb-2">Waiting for trump selection</h2>
              <p class="text-gray-600">Waiting for {{ getPartyPlayerName() }} to choose the trump suit.</p>
            }
          </div>
        }

        <!-- Player Decision (opt-in/opt-out) -->
        @if (gameState()!.currentRound && isRoundStatus(gameState()!.currentRound!.status, 2)) {
          <div class="bg-white rounded-lg shadow-lg p-6">
            @if (hasMadePlayDecision()) {
              <h2 class="text-xl font-bold mb-2">Waiting for other players...</h2>
              <p class="text-gray-600">
                You've submitted your decision for this round. Waiting for everyone to decide.
              </p>
            } @else {
              <h2 class="text-xl font-bold mb-4">Play This Round?</h2>
              <p class="text-gray-600 mb-6">
                Decide whether you want to participate in this round. 
                @if (isPartyPlayer()) {
                  <span class="text-orange-600 font-semibold">You must play this round.</span>
                } @else if (gameState()!.currentRound!.trumpSuit === 'Clubs') {
                  <span class="text-orange-600 font-semibold">Clubs trump - all players must play!</span>
                } @else {
                  <span>Consider your hand and current points ({{ getMyPoints() }}).</span>
                }
              </p>
              <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                <button
                  (click)="makePlayDecision(true)"
                  [disabled]="makingDecision()"
                  class="flex items-center justify-center gap-2 px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                >
                  <span class="text-2xl">✓</span>
                  <span>Play</span>
                </button>
                <button
                  (click)="makePlayDecision(false)"
                  [disabled]="makingDecision() || isPartyPlayer() || gameState()!.currentRound!.trumpSuit === 'Clubs'"
                  class="flex items-center justify-center gap-2 px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                >
                  <span class="text-2xl">✗</span>
                  <span>Sit Out</span>
                </button>
              </div>
            }
          </div>
        }

        <!-- Card Exchange -->
        @if (gameState()!.currentRound && isRoundStatus(gameState()!.currentRound!.status, 3) && getMyHand().length > 0) {
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Card Exchange</h2>
            <p class="text-gray-600 mb-6">
              Select up to 3 cards to exchange. You cannot exchange the Ace of trump ({{ getCardSymbol(gameState()!.currentRound!.trumpSuit!) }} Ace).
              @if (cardsToExchange().length > 0) {
                <span class="font-semibold text-blue-600">{{ cardsToExchange().length }} card(s) selected</span>
              }
            </p>
            <div class="flex justify-center gap-4 flex-wrap mb-6">
              @for (card of getMyHand(); track card.suit + card.rank) {
                <button
                  (click)="toggleCardForExchange(card)"
                  [disabled]="exchangingCards() || (card.rank === 'Ace' && card.suit === gameState()!.currentRound!.trumpSuit)"
                  [class]="'w-24 h-36 bg-white border-2 rounded-lg shadow-md p-2 flex flex-col items-center justify-center transition-all ' +
                           (isCardSelectedForExchange(card) ? 'border-blue-500 ring-2 ring-blue-500 -translate-y-2' : 'border-gray-300 hover:border-blue-300') +
                           (exchangingCards() || (card.rank === 'Ace' && card.suit === gameState()!.currentRound!.trumpSuit) ? ' opacity-50 cursor-not-allowed' : ' hover:-translate-y-1 cursor-pointer')"
                >
                  <div [class]="'text-4xl ' + getCardColor(card.suit)">
                    {{ getCardSymbol(card.suit) }}
                  </div>
                  <div [class]="'text-2xl font-bold ' + getCardColor(card.suit)">
                    {{ getRankDisplay(card.rank) }}
                  </div>
                </button>
              }
            </div>
            <div class="flex justify-center gap-4">
              <button
                (click)="confirmCardExchange()"
                [disabled]="exchangingCards()"
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
              >
                @if (exchangingCards()) {
                  <span>Exchanging...</span>
                } @else if (cardsToExchange().length > 0) {
                  <span>Exchange {{ cardsToExchange().length }} Card(s)</span>
                } @else {
                  <span>Keep All Cards</span>
                }
              </button>
            </div>
          </div>
        }

        <!-- Players Info -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
          @for (player of gameState()!.players; track player.id) {
            <div [class]="'bg-white rounded-lg shadow p-4 ' + (player.userId === authService.currentUser()?.id ? 'ring-2 ring-blue-500' : '')">
              <div class="flex items-center gap-2 mb-2">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">
                  {{ player.displayName.charAt(0).toUpperCase() }}
                </div>
                <div class="flex-1">
                  <p class="font-semibold text-sm">{{ player.displayName }}</p>
                  <p class="text-xs text-gray-500">Position {{ player.position }}</p>
                </div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-lg font-bold text-blue-600">{{ player.currentPoints }} pts</span>
                @if (gameState()!.currentRound && player.userId === gameState()!.currentRound!.dealerUserId) {
                  <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Dealer</span>
                }
                @if (gameState()!.currentRound && player.userId === gameState()!.currentRound!.partyPlayerUserId) {
                  <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Party</span>
                }
              </div>
            </div>
          }
        </div>

        <!-- Current Trick -->
        @if (gameState()!.currentRound && gameState()!.currentRound!.currentTrick && gameState()!.currentRound!.currentTrick!.cardsPlayed.length > 0) {
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Current Trick #{{ gameState()!.currentRound!.currentTrick!.trickNumber }}</h2>
            <div class="flex justify-center gap-4 flex-wrap">
              @for (played of gameState()!.currentRound!.currentTrick!.cardsPlayed; track played.playerPosition) {
                <div class="text-center">
                  <div class="w-24 h-36 bg-white border-2 border-gray-300 rounded-lg shadow-md p-2 flex flex-col items-center justify-center">
                    <div [class]="'text-4xl ' + getCardColor(played.card.suit)">
                      {{ getCardSymbol(played.card.suit) }}
                    </div>
                    <div [class]="'text-2xl font-bold ' + getCardColor(played.card.suit)">
                      {{ getRankDisplay(played.card.rank) }}
                    </div>
                  </div>
                  <p class="text-sm text-gray-600 mt-1">Pos {{ played.playerPosition }}</p>
                </div>
              }
            </div>
          </div>
        }

        <!-- My Hand -->
        @if (getMyHand().length > 0) {
          <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold">Your Hand</h2>
              @if (isMyTurn()) {
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold animate-pulse">
                  Your Turn
                </span>
              }
            </div>
            <div class="flex justify-center gap-4 flex-wrap">
              @for (card of getMyHand(); track card.suit + card.rank) {
                <button
                  (click)="selectCard(card)"
                  [disabled]="!isMyTurn()"
                  [class]="'w-24 h-36 bg-white border-2 rounded-lg shadow-md p-2 flex flex-col items-center justify-center transition-all ' +
                           (selectedCard()?.suit === card.suit && selectedCard()?.rank === card.rank ? 'border-blue-500 ring-2 ring-blue-500 -translate-y-2' : 'border-gray-300 hover:border-blue-300') +
                           (!isMyTurn() ? ' opacity-50 cursor-not-allowed' : ' hover:-translate-y-1 cursor-pointer')"
                >
                  <div [class]="'text-4xl ' + getCardColor(card.suit)">
                    {{ getCardSymbol(card.suit) }}
                  </div>
                  <div [class]="'text-2xl font-bold ' + getCardColor(card.suit)">
                    {{ getRankDisplay(card.rank) }}
                  </div>
                </button>
              }
            </div>
            @if (selectedCard() && isMyTurn()) {
              <div class="mt-4 text-center">
                <button
                  (click)="playSelectedCard()"
                  class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                >
                  Play {{ getRankDisplay(selectedCard()!.rank) }} of {{ selectedCard()!.suit }}
                </button>
              </div>
            }
          </div>
        }

        <!-- Completed Tricks -->
        @if (gameState()!.currentRound && gameState()!.currentRound!.tricks.length > 0) {
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Completed Tricks</h2>
            <div class="space-y-2">
              @for (trick of gameState()!.currentRound!.tricks; track trick.trickNumber) {
                @if (trick.winnerPlayerSessionId !== null) {
                  <div class="flex items-center gap-4 p-3 bg-gray-50 rounded">
                    <span class="font-semibold">Trick {{ trick.trickNumber }}:</span>
                    <span class="text-gray-600">Won by {{ getWinnerLabel(trick) }}</span>
                    <div class="flex gap-2 ml-auto">
                      @for (played of trick.cardsPlayed; track played.playerPosition) {
                        <div [class]="'text-sm ' + getCardColor(played.card.suit)">
                          {{ getRankDisplay(played.card.rank) }}{{ getCardSymbol(played.card.suit) }}
                        </div>
                      }
                    </div>
                  </div>
                }
              }
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>
